# sarsim
Simulation of multi-channel SAR signals in python. Also simulating orbits around solar system planets

## Pupose
This repository of python code contains coded algorithms for generating simulations
of SAR signals. Specifically, the SAR signals are generated from a multi-channel
phased-array or similar system. The aim is to provide expected results from different
configurations of a multi-channel SAR system for different objectives inlcuding
- High Resolution Wide Swath (HRWS) modes
- SUper REsolution Stripmap (SURE) modes 
- Uniform arclength sampled signals for long aperture SAR, and expected Omega-K processing

## Motivation
Python contains all the tools required to generate this type of simulation. For those without access
to commercial software, such as Matlab, Mathematica, IDL, e.t.c., this package provides an
alternative means to generate simulations.

## Python Tools
Python libraries used include (bold entries are essential)
- **scipy**
- **numpy**
- **numba**
- **matplotlib**
- **tqdm**
- **lxml**
- **quaternion** conda-forge
- **astropy**
- Jupyter 
- Jupyterlab

These can be installed with anaconda using

**conda install conda-build spyder jupyter jupyterlab numpy numba scipy lxml matplotlib cudatoolkit**

## Method of simulation
Simulations are drived from XML configuration files. The goal is to model the signal capture 
configuration in these XML files and produce the expected Point Spread Function (PSF), also 
in the presence of noise.

The XML configuration file describes the radar antenna, the radar mode and the radar platform during
image capture. The flexibility of the XML description allows for 
- Standard stripmap
- HRWS
- SURE
- Ping-pong modes
- Variable beams from pulse to pulse or burst to burst
- Variable phase centres from pulse to pulse or burst to burst

XML configuration files can be generated by the provided python scripts (generateSURE.py)

## Running the code (On a generic system)
- Generate the simulation xml file

  `python -m generateSUREConfig --az-resolution 0.12 --rn-resolution 0.12 --config-xml ./12cm_sim.xml`
  
  This sets up the xml file with all the required simulation information
  
- Setup the simulation by generating pickle files for objects that take time to compute. 
  
  For example:
  
  `python -m setupSimulation --config-xml 12cm_sim.xml --ref-rangeidx 400 --target-rangeidx 400 --rblock-size 256 --xblock-size 8192 --number-processors 12 --number-mchan-processors 6 --vanilla-stolt`
  
- Compute the raw data signals with the
  
  `python -m generateMsar`
  
  commands found in the commands file
- Multi-channel process these raw signals with the
  
  `python -m processMultiChannel`
  
  commands found in the commands file
- SAR process the multi-channel processed signal with the
  
  `python -m sarProcess`
  
  commands found in the commands file
  
## Running the code (Specifically for the VSC)
- Generate the simulation xml file. For example, navigate to the `/global` partition and enter:

  `python -m generateSUREConfig --az-resolution 0.12 --rn-resolution 0.12 --config-xml ./12cm_sim.xml`
  
  This sets up the xml file with all the required simulation information
  
- Setup the simulation by generating pickle files for objects that take time to compute. 
  
  For example:
  
  `python -m setupSimulation --config-xml 12cm_sim.xml --ref-rangeidx 400 --target-rangeidx 400 --rblock-size 256 --xblock-size 8192 --number-processors 12 --number-mchan-processors 6 --vanilla-stolt`
  
  This script also generates a bash scripts designed to run the rest of the 
  simulation. The script can run the commands in parallel up to each **wait** 
  point.
  
  `python -m setupSimulation --config-xml 12cm_sim.xml --ref-rangeidx 400 --target-rangeidx 400 --rblock-size 256 --xblock-size 8192 --number-processors 12 --number-mchan-processors 6 --vanilla-stolt`
  
  The setupSimulation script computes the radar system object and stores
  it as a pickled object. It also computes the multi-channel processing filter
  and also stores it as a pickled object. The generated shell scripts all contain the required
  slurm commands to run on the VSC. They all start with the following lines
  ```shell
  #!/bin/bash
  #SBATCH -J sarsim
  #SBATCH -N 1
  eval \"$(conda shell.bash hook)\"
  conda activate radar
  ```
  The script signal_template12cm_sim.sh may need to be made executable if the script 
  signal_compute_array12cm_sim.sh is to be run. This can be accomplished with
  `chmod u+x signal_template12cm_sim.sh`. It may also be desirable to modify the array
  line in `signal_compute_array12cm_sim.sh` to indicate a maximum number of jobs to run
  simultaneously, i.e. change the line
  ```shell
  #SBATCH --array 0-99:1
  ```
  to
  ```shell
  #SBATCH --array 0-99:1%4
  ```
  On the VSC, the script to generate the raw signal can be supplied with
  
  `sbatch --qos normal_0128 -p mem_0128 signal_compute_array12cm_sim.sh`
  
  The scripts listed in `multichannel_compute_[0-9][0-9]_12cm_sim.sh` and in
  `omegak_compute_[0-9][0-9]_12cm_sim.sh` can be submitted with the following
  
  `ls -l multichannel_compute_*_12cm_sim.sh | awk '{print "sbatch --qos normal_0128 -p mem_0128 " $9}' | bash`
  
  and
  
  `ls -l omegak_compute_*_12cm_sim.sh | awk '{print "sbatch --qos normal_0128 -p mem_0128 " $9}' | bash`
  
  repectively (i.e. in order).
  
## API
Here is an axample of using the API to recover state vectors
`http://127.0.0.1:8000/integrate?timeUTC=2018-08-04T23:00:32.000000&x=-527980.819268&y=4847142.650836&z=-5135381.160956&vx=2469.603342&vy=-5079.616823&vz=-5052.480793&dt=10`
  
## To do
- [x] Implement tqdm progressbar update
- [X] Investigate how to make a script to fire the processing on a cluster
- [x] Split data into manageable chunks for processing
- [X] Confirm that the FFT interpolation with frequency offet is working
- [X] With bash script generation, incorporate the number of processors into
      the nunber of processes running at any time
